
@{
    ViewBag.Title = "RPEvent";
    Layout = "~/Views/Shared/_Layout.cshtml";
    <h2 class="text-black border-bottom border-info shadow-lg mt-05">REPORTE DE EVENTOS</h2>
}

@Styles.Render("~/Content/css")
<main class="maincl">
    <div class="principal1 shadow-lg">
        <div class="card">
            <div>
                <div class="dv1 mr-1">
                    <div class="input-group mb-3 mr-2">
                        <span class="input-group-text" id="basic-addon1">Desde</span>
                        <input type="date" class="form-control pr-2" id="Desde" aria-label="Nombre de usuario" aria-describedby="basic-addon1" required>
                    </div>
                    <div class="divider"></div>
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Hasta</span>
                        <input type="date" class="form-control metrica" id="Hasta" aria-label="Nombre de usuario" aria-describedby="basic-addon1" required>
                    </div>
                    <div class="divider"></div>
                    <select id="tipo" class="form-select" aria-label="Default select example">
                        <option selected>Abre este menú select</option>
                        <option value="1">Dominical</option>
                        <option value="2">Oracion</option>
                        <option value="3">Reunion de Jovenes</option>
                    </select>
                </div>
                <div class="dv2">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">usuario</span>
                        <input type="text" class="form-control " id="user" placeholder="Nombre de usuario" aria-label="Nombre de usuario" aria-describedby="basic-addon1" required>
                        <button type="button" onclick="buscar()" class="btn btn-success mr-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                            </svg>
                            Buscar
                        </button>
                    </div>

                </div>
            </div>

        </div>


        <div id="Reportrecicler" class="contenedor_P bg-light" style="text-align:center; display:none;">
            
            <div class="elemento_S" id="hot"></div>

        </div>
    </div>

</main>



<script>

    function buscar() {

        var sr = document.getElementById("Reportrecicler");
        sr.style.display = "";
        var url2 = "@Url.Action("Reportvento", "Event")";
        var FI = $("#Desde").val()
        var FF = $("#Hasta").val()
        if (FF == "" || FI == "") {
            alert("Campos de fecha no pueden estar vacios")
        } else {
            data = {
                FI,
                FF,
                USER: $("#user").val(),
            }
            console.log(data);
            $.post(url2, data).done(function (data) {
                console.log(data);
                Mostrarxls(data.data)
                generarXLS(FI, FF, data.data)
            });
        }
    }
    function Mostrarxls(data){
        // Configuración de Handsontable
        var container = document.getElementById('hot');
        var hot = new Handsontable(container, {
            licenseKey: 'non-commercial-and-evaluation',
            data: data,
            colHeaders: ['ID', 'Nombre', 'Fecha', 'LugarEvento', 'Descripcion', 'estado', 'Usuario','Cargo'],
            columns: [
                { data: 'IdEvento' },
                { data: 'Nombre' },
                { data: 'Fecha' },
                { data: 'LugarEvento' },
                { data: 'Descripcion' },
                { data: 'estado' },
                { data: 'Usuario' },
                { data: 'Cargo' },
            ]
        });
    }

    function dowxls() {
             var url2 = "@Url.Action("Reportvento", "Event")";
        var FI = $("#Desde").val()
        var FF = $("#Hasta").val()
        data = {
            FI,
            FF,
            USER: $("#user").val(),
        }
        console.log(data);
               $.post(url2, data).done(function (data) {
                   console.log(data);
                   generarXLS(FI,FF,data.data)
               });
    }
    function generarXLS(desde, hasta, data) {
        // Crear un nuevo libro de trabajo
        const workbook = new ExcelJS.Workbook();
        // Crear una nueva hoja de cálculo
        const worksheet = workbook.addWorksheet('Datos');



        // Fusionar celdas y establecer el texto 'desde' en A2:C2
        const desdeCell = worksheet.getCell('A2');
        desdeCell.value = 'desde ' + desde;
        worksheet.mergeCells('A2:C2');

        // Fusionar celdas y establecer el texto 'hasta' en D2:F2
        const hastaCell = worksheet.getCell('D2');
        hastaCell.value = 'hasta ' + hasta;
        worksheet.mergeCells('D2:G2');

        // Fusionar celdas y establecer el texto 'REPORTE GENERAL DE ASISTENCIAS' en A3:F3
        const reportCell = worksheet.getCell('A3');
        reportCell.value = 'REPORTE GENERAL DE EVENTOS';
        reportCell.alignment = { horizontal: 'center' };
        reportCell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF0000FF' } // Fondo azul
        };
        worksheet.mergeCells('A3:G3');

        const reportCell1 = worksheet.getCell('A4');
        reportCell1.value1 = '';
        reportCell1.alignment = { horizontal: 'center' };


        // Configurar los encabezados de columna
        worksheet.columns = [
            { header: 'ID', key: 'IdEvento' },
            { header: 'Nombre', key: 'Nombre' },
            { header: 'Fecha', key: 'Fecha' },
            { header: 'LugarEvento', key: 'LugarEvento' },
            { header: 'Descripcion', key: 'Descripcion' },
            { header: 'Usuario', key: 'Usuario' },
            { header: 'Cargo', key: 'Cargo' },
        ];
     
        // Aplicar estilos a los encabezados de columna
        const headerRow = worksheet.getRow(1);
        headerRow.eachCell((cell) => {
            cell.font = { color: { argb: '000000' } }; // Color de fuente negro (hexadecimal)
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF006400' } // Color de fondo verde oscuro (hexadecimal)
            };
        });

        // Agregar los datos a la hoja de cálculo
        // Agregar los datos a la hoja de cálculo
        data.forEach((row, index) => {
            const newRow = worksheet.addRow(row);
            newRow.eachCell((cell) => {
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' },
                };
            });

            // Verificar si es la primera fila de datos (después de los encabezados)
            if (index === 0) {
                // Obtener la última celda de la fila
                const lastCell = newRow.getCell(worksheet.columns.length);
                // Fusionar las celdas desde A4 hasta la última celda de la fila
                worksheet.mergeCells(`A4:${lastCell.address}`);
            }
        });

        // Fusionar celdas y establecer el texto 'ASISTENCIAS IBH' en A1:F1
        const titleCell = worksheet.getCell('A1');
        titleCell.value = 'EVENTOS IBH';
        titleCell.alignment = { horizontal: 'center' };
        titleCell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF0000FF' } // Fondo azul
        };
        worksheet.mergeCells('A1:G1');
        // Generar el archivo de Excel
        workbook.xlsx.writeBuffer().then((buffer) => {
            // Descargar el archivo
            const blob = new Blob([buffer], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'EVENTOS.xlsx';
            link.click();
            URL.revokeObjectURL(url);
        });
    }

</script>